<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoproPro - Sistema Profissional</title>
    <style>
        :root { 
            --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; 
            --success: #27ae60; --warning: #f39c12; --bg: #f4f7f6; 
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 25px; border: 1px solid #e0e0e0; }
        h2 { color: var(--primary); border-left: 6px solid var(--accent); padding-left: 15px; font-size: 1.3rem; margin-top: 0; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .grid-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 0.85rem; margin-bottom: 6px; color: #555; }
        input, select { padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 1rem; transition: 0.3s; outline: none; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(52, 152, 219, 0.2); }
        .refugo-area { background: #fff5f5; padding: 20px; border-radius: 10px; border: 1px solid #fed7d7; margin-top: 20px; }
        .refugo-controls { display: flex; gap: 10px; align-items: flex-end; }
        .btn-add { background: var(--danger); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; height: 48px; font-size: 1.5rem; }
        .lista-tags { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .refugo-item { background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--danger); display: flex; align-items: center; font-weight: bold; color: var(--danger); font-size: 0.9rem; }
        .btn-remove-tag { margin-left: 10px; cursor: pointer; color: #999; font-size: 1.2rem; border: none; background: none; }
        .res-box { background: var(--primary); color: white; padding: 20px; border-radius: 12px; margin-top: 25px; display: flex; justify-content: space-around; text-align: center; }
        .res-item span { display: block; font-size: 1.8rem; font-weight: bold; color: var(--warning); margin-top: 5px; }
        .btn-save { padding: 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; margin-top: 20px; background: var(--success); color: white; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 3px solid #dee2e6; color: var(--primary); }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .btn-del { color: #ccc; cursor: pointer; background: none; border: none; font-size: 1.2rem; transition: 0.2s; }
        .btn-del:hover { color: var(--danger); }
        #status { text-align: center; margin-top: 15px; font-weight: bold; padding: 12px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>üë• Lan√ßamento de Turno</h2>
        
        <div class="grid-input">
            <div class="form-group"><label>Meta Esperada</label><input type="number" id="meta_calc" oninput="calcular()" placeholder="Ex: 5000"></div>
            <div class="form-group">
                <label>Operador</label>
                <select id="operador_nome">
                    <option value="">Selecione...</option>
                    <option>Alexander</option><option>Daiane</option><option>Dalyane</option><option>Welington</option>
                </select>
            </div>
            <div class="form-group">
                <label>Equipamento</label>
                <select id="maquina_id">
                    <option value="">Selecione...</option>
                    <option>AUTOBLOW 1</option><option>AUTOBLOW 2</option><option>AUTOBLOW 3</option><option>BA 1</option><option>BA 2</option>
                </select>
            </div>
            <div class="form-group"><label>C√≥digo OP</label><input type="text" id="op_nome" placeholder="Digite a OP"></div>
            <div class="form-group"><label>Pe√ßas Boas</label><input type="number" id="boas_total" oninput="calcular()" placeholder="Qtd Boas"></div>
            <div class="form-group"><label>Mo√≠do (Kg)</label><input type="number" id="moido_total" step="0.01" placeholder="Ex: 12.50"></div>
        </div>

        <div class="refugo-area">
            <label style="color: var(--danger)">Lan√ßar Motivos de Refugo</label>
            <div class="refugo-controls">
                <select id="motivo_refugo" style="flex:2">
                    <option>Ajustes</option><option>Fora do peso</option><option>Setup</option><option>Furos/Bolhas</option><option>Contamina√ß√£o</option>
                </select>
                <input type="number" id="qtd_refugo_parcial" style="flex:1" placeholder="Qtd">
                <button type="button" class="btn-add" onclick="adicionarRefugo()">+</button>
            </div>
            <div id="lista_refugos_texto" class="lista-tags"></div>
        </div>

        <div class="res-box">
            <div class="res-item"><p>Efici√™ncia GERAL</p><span id="kpi_prod">0%</span></div>
            <div class="res-item"><p>Perda por Refugo</p><span id="kpi_refugo_perc">0%</span></div>
        </div>

        <button id="btnSalvar" class="btn-save" onclick="salvarSeguro()">Finalizar e Gravar no Banco</button>
        <div id="status"></div>
    </div>

    <div class="card">
        <h2>üìä Hist√≥rico Recente <button onclick="carregar()" style="float:right; border:none; background:none; cursor:pointer; font-size:1.2rem; color: var(--accent);">üîÑ</button></h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>Data/Hora</th><th>OP</th><th>M√°quina</th><th>Boas</th><th>Efic. %</th><th>A√ß√µes</th></tr>
                </thead>
                <tbody id="corpo-tabela"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const DB_URL = "https://producao-a16ef-default-rtdb.firebaseio.com/producao";
    let resumoRefugos = {};
    let totalRefugoGeral = 0;

    function calcular() {
        const meta = parseFloat(document.getElementById('meta_calc').value) || 0;
        const boas = parseFloat(document.getElementById('boas_total').value) || 0;
        const totalProd = boas + totalRefugoGeral;
        
        const ef = meta > 0 ? (boas / meta * 100) : 0;
        const rf = totalProd > 0 ? (totalRefugoGeral / totalProd * 100) : 0;
        
        document.getElementById('kpi_prod').innerText = ef.toFixed(1) + "%";
        document.getElementById('kpi_refugo_perc').innerText = rf.toFixed(1) + "%";
    }

    function adicionarRefugo() {
        const mot = document.getElementById('motivo_refugo').value;
        const qtd = parseInt(document.getElementById('qtd_refugo_parcial').value) || 0;
        if(qtd > 0) {
            resumoRefugos[mot] = (resumoRefugos[mot] || 0) + qtd;
            totalRefugoGeral += qtd;
            document.getElementById('qtd_refugo_parcial').value = "";
            renderizarRefugos();
            calcular();
        }
    }

    function removerRefugo(mot) {
        totalRefugoGeral -= resumoRefugos[mot];
        delete resumoRefugos[mot];
        renderizarRefugos();
        calcular();
    }

    function renderizarRefugos() {
        const div = document.getElementById('lista_refugos_texto');
        div.innerHTML = "";
        for (const [mot, qtd] of Object.entries(resumoRefugos)) {
            div.innerHTML += `
                <div class="refugo-item">
                    ${mot}: ${qtd}
                    <button class="btn-remove-tag" onclick="removerRefugo('${mot}')">√ó</button>
                </div>`;
        }
    }

    async function salvarSeguro() {
        const btn = document.getElementById('btnSalvar');
        const status = document.getElementById('status');
        
        const dados = {
            data: new Date().toLocaleDateString('pt-BR'),
            hora: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
            meta: parseFloat(document.getElementById('meta_calc').value) || 0,
            operador: document.getElementById('operador_nome').value,
            maquina: document.getElementById('maquina_id').value,
            op: document.getElementById('op_nome').value,
            boas: parseInt(document.getElementById('boas_total').value) || 0,
            moido: parseFloat(document.getElementById('moido_total').value) || 0,
            refugos: resumoRefugos,
            total_refugo: totalRefugoGeral,
            eficiencia: document.getElementById('kpi_prod').innerText,
            timestamp: Date.now()
        };

        if(!dados.operador || !dados.maquina || !dados.op) {
            alert("Preencha Operador, M√°quina e OP.");
            return;
        }

        try {
            btn.disabled = true;
            btn.innerText = "GRAVANDO...";
            
            const res = await fetch(`${DB_URL}.json`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });

            if(res.ok) {
                status.style.display = "block";
                status.style.background = "#d4edda";
                status.innerText = "‚úÖ Salvo com sucesso!";
                limparFormulario();
                carregar();
            }
        } catch (e) {
            alert("Erro ao salvar.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Finalizar e Gravar no Banco";
            setTimeout(() => status.style.display = "none", 3000);
        }
    }

    function limparFormulario() {
        document.getElementById('op_nome').value = "";
        document.getElementById('boas_total').value = "";
        document.getElementById('moido_total').value = "";
        resumoRefugos = {};
        totalRefugoGeral = 0;
        renderizarRefugos();
        calcular();
    }

    async function carregar() {
        const corpo = document.getElementById('corpo-tabela');
        corpo.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";
        
        try {
            // Buscamos os dados do Firebase
            const res = await fetch(`${DB_URL}.json`);
            const data = await res.json();
            
            corpo.innerHTML = "";
            
            if (data) {
                // Transformamos o objeto do Firebase em array e ordenamos pelo timestamp (mais novo primeiro)
                const lista = Object.keys(data)
                    .map(id => ({ id, ...data[id] }))
                    .sort((a, b) => b.timestamp - a.timestamp);

                lista.slice(0, 10).forEach(item => {
                    corpo.innerHTML += `
                        <tr>
                            <td>${item.data || '--'} ${item.hora || '--'}</td>
                            <td>${item.op || '--'}</td>
                            <td>${item.maquina || '--'}</td>
                            <td>${item.boas || 0}</td>
                            <td style="color:var(--success); font-weight:bold">${item.eficiencia || '0%'}</td>
                            <td><button class="btn-del" onclick="deletar('${item.id}')">üóëÔ∏è</button></td>
                        </tr>`;
                });
            } else {
                corpo.innerHTML = "<tr><td colspan='6'>Nenhum registro encontrado.</td></tr>";
            }
        } catch (e) {
            corpo.innerHTML = "<tr><td colspan='6'>Erro de conex√£o com o banco.</td></tr>";
        }
    }

    async function deletar(id) {
        if(confirm("Excluir este lan√ßamento?")) {
            await fetch(`${DB_URL}/${id}.json`, { method: 'DELETE' });
            carregar();
        }
    }

    // Carrega os dados assim que a p√°gina abre
    window.onload = carregar;
</script>
</body>
</html>
